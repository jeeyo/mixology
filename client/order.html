<!DOCTYPE html>
<html>
  <head>
    <title>Mixology</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/fa.css">
    <style>
      html, body {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .mix-order-ingredient-btn {
        width: 120px;
        height: 120px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <button class="btn" type="button" id="mix-conn-status-btn">
        <span class="fa fa-redo"></span>
      </button>
    </nav>

    <button class="btn btn-dark" id="mix-order-order-btn">Order</button>

    <div class="d-flex flex-column">
      <div class="d-flex flex-row">
        <button class="btn btn-danger d-inline-block mix-order-ingredient-btn" data-mix-order-val="Red">
          <p>Lambay</p>
          <p>Red</p>
        </button>
        <button class="btn btn-danger d-inline-block mix-order-ingredient-btn" data-mix-order-val="Blue">
          <p>Lambay</p>
          <p>Blue</p>
        </button>
      </div>
      
      <div class="d-flex flex-row">
        <button class="btn btn-warning d-inline-block mix-order-ingredient-btn" data-mix-order-val="Oj">Oj</button>
        <button class="btn btn-warning d-inline-block mix-order-ingredient-btn" data-mix-order-val="Pj">Pj</button>
        <button class="btn btn-warning d-inline-block mix-order-ingredient-btn" data-mix-order-val="Aj">Aj</button>
        <button class="btn btn-warning d-inline-block mix-order-ingredient-btn" data-mix-order-val="Sj">Sj</button>
        <button class="btn btn-warning d-inline-block mix-order-ingredient-btn" data-mix-order-val="Psj">Psj</button>
        <button class="btn btn-warning d-inline-block mix-order-ingredient-btn" data-mix-order-val="Lj">Lj</button>
      </div>
      
      <div class="d-flex flex-row">
        <button class="btn btn-success d-inline-block mix-order-ingredient-btn" data-mix-order-val="Lys">Lys</button>
        <button class="btn btn-success d-inline-block mix-order-ingredient-btn" data-mix-order-val="Ots">Ots</button>
        <button class="btn btn-success d-inline-block mix-order-ingredient-btn" data-mix-order-val="Vas">Vas</button>
        <button class="btn btn-success d-inline-block mix-order-ingredient-btn" data-mix-order-val="Aps">Aps</button>
        <button class="btn btn-success d-inline-block mix-order-ingredient-btn" data-mix-order-val="Sts">Sts</button>
        <button class="btn btn-success d-inline-block mix-order-ingredient-btn" data-mix-order-val="Ss">Ss</button>
      </div>
    </div>

    <script src="js/jquery-3.0.0.slim.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/socket.io.js"></script>
    <script>

      const FORMULAS = [
        ['Red', 'Aj', 'Bj', 'Lj', 'Mb', 'Ss'],
        ['Blue', 'Psj', 'Sj', 'Lj', 'Lys', 'Ss'],
        ['Red', 'Oj', 'Pj', 'Lj', 'Vas', 'Ss'],
        ['Blue', 'Psj', 'Bj', 'Lj', 'Ots', 'Ss'],
        ['Red', 'Sj', 'Oj', 'Lj', 'Sts', 'Ss'],
        ['Blue', 'Aj', 'Pj', 'Lj', 'Aps', 'Ss'],
      ];
      const MIXTURES = ['Jazzcuzzi', 'Frisky', 'Latinos', 'Eelektross', 'Rockumantary', 'A K A Hip'];
      const COLORS = ['#CDC0DF', '#FCD6D6', '#FFCF59', '#B070AF', '#F5949E', '#FBF27E'];
      const GENRES = ['Jazz', 'Funk', 'Latin', 'Electronics', 'Rock', 'Hip-Hop'];

      const ALL_INGREDIENTS = [
        'Red', 'Blue',
        'Oj', 'Pj', 'Aj', 'Sj', 'Psj', 'Lj',
        'Lys', 'Ots', 'Vas', 'Aps', 'Sts', 'Ss',
      ];

      var my_formula = [];
      var available_ingredients = ALL_INGREDIENTS;

      var socket = io('http://localhost:3000/order', {
        reconnection: true,
        reconnectionDelay: 500,
        reconnectionAttempts: 10,
      });

      socket.on('connect', function() {
        console.log('WS Connected');
        $('#mix-conn-status-btn').removeClass('btn-success btn-danger');
        $('#mix-conn-status-btn').addClass('btn-success');
      });
      socket.on('disconnect', function() {
        console.log('WS Disconnected');
        $('#mix-conn-status-btn').removeClass('btn-success btn-danger');
        $('#mix-conn-status-btn').addClass('btn-danger');
      });

      $('#mix-conn-status-btn').on('click', function() {
        location.reload();
      });

      $('.mix-order-ingredient-btn').on('click', function() {

        var removing_ingredients = [];
        var ingredient = $(this).data('mix-order-val');

        if(my_formula.indexOf(ingredient) < 0)
          my_formula.push(ingredient);
        
        if(my_formula.length >= 6) {
          $('#mix-order-order-btn').removeClass('disabled');

          var matched_index = FORMULAS.findIndex(f => JSON.stringify(f.slice().sort()) === JSON.stringify(my_formula.slice().sort()));
        }

        // Remove ingredients from non-found
        FORMULAS.forEach(f => {
          if(f.indexOf(ingredient) < 0)
            removing_ingredients = removing_ingredients.concat(f);
        });
        // Add back from found
        FORMULAS.forEach(f => {
          if(f.indexOf(ingredient) > -1)
            removing_ingredients = removing_ingredients.filter(m => f.indexOf(m) < 0);
        });
        // Remove itself
        removing_ingredients.push(ingredient);
        available_ingredients = available_ingredients.filter(m => removing_ingredients.indexOf(m) < 0);

        $('.mix-order-ingredient-btn').removeClass('disabled');
        $('.mix-order-ingredient-btn').each((i, v) => {
          var m = $(v).data('mix-order-val');
          if(available_ingredients.indexOf(m) < 0)
            $(v).addClass('disabled');
        });
      });

      $('#mix-order-order-btn').on('click', function() {
        var matched_index = FORMULAS.findIndex(f => JSON.stringify(f.slice().sort()) === JSON.stringify(my_formula.slice().sort()));
        socket.emit('new', { mixture: matched_index });
      });
    </script>
  </body>
</html>